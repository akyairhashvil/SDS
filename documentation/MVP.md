# SDS MVP Specification (Peer-Review Consolidation)
**Document:** SDS_MVP.md  
**Version:** v0.1.0 (MVP)  
**Date:** 2026-01-19  
**Status:** Draft → Implementable  
**Scope:** Build a functional SDS MVP by converting peer-review findings into an implementable plan.

---

## 0. Purpose
SDS (Secure Document System) is a terminal-native writing environment designed to reduce accidental persistence and to constrain **egress** (export/copy) into **auditable, intentional acts**, while keeping stored documents encrypted at rest (SQLCipher) and producing a “Clean Document” PDF export.

This document **is the MVP**: it defines what we build, how we build it, and how we prove it works—using the peer review as the primary constraint set.

---

## 1. MVP Definition of Done
The MVP is “done” when a user can:

1. **Create a vault**, unlock it, and **create/edit** documents in a TUI.
2. Store documents **encrypted at rest** (SQLCipher) with **Argon2id** key derivation.
3. **Search** documents using FTS5 (with documented scale expectations + benchmark harness).
4. **Export** a document to PDF (Maroto), followed by a **PDF sanitization pass** (metadata + deterministic normalization).
5. **Copy** a selection via **OSC 52** only through an explicit confirmation UI, and have the action recorded in an **append-only audit log**.
6. Operate in **Lax Mode** (freeform drafting), with structure enforcement deferred to export-time validation.

---

## 2. Threat Model (MVP)
### 2.1 Assets
- **Document plaintext** during editing (in memory).
- **Vault ciphertext** at rest.
- **Metadata** (titles, tags, doc sizes, access patterns).
- **Egress events** (clipboard and PDFs).

### 2.2 Adversaries (MVP-relevant)
- Offline attacker who exfiltrates the vault file.
- Opportunistic attacker with access to the user account, clipboard history, or filesystem artifacts.
- “Ambient leakage” risks: terminal scrollback, multiplexer buffers, OS core dumps, swap, PDF metadata.

### 2.3 Out of Scope (explicit non-goals for MVP)
SDS MVP does **not** claim to defend against:
- A fully compromised OS/kernel/hypervisor.
- Hardware keyloggers / DMA attacks (Thunderbolt/PCIe) without system-level mitigations.
- Screen capture / live video / shoulder surfing.
- Side-channel attacks requiring specialized local adversaries (cache timing, TEMPEST, etc.).
- Forensic recovery from external apps after the user manually copies plaintext out.

**MVP stance:** SDS reduces persistence and increases auditability; it is not a magical “perfect secrecy machine.” UX must state this plainly to prevent a false sense of security.

---

## 3. Architectural Overview
### 3.1 High-level components
- **TUI Frontend (tcell):** document list, editor, search UI, export UI, audit viewer.
- **Vault Core:** unlock, KDF, key lifecycle, storage APIs.
- **Storage (SQLCipher):** encrypted persistence; schema + migrations.
- **Search (FTS5):** full-text search over documents (external content table).
- **Export Pipeline:** markdown-ish parsing → Maroto PDF → sanitization/normalization.
- **Egress Controller:** OSC52 clipboard; export gating; audit events.

### 3.2 Data flow (plaintext lifecycle)
1. Keystrokes arrive via terminal/tcell event queue (untrusted, leaky buffer potential).
2. SDS copies runes into its editor buffer (prefer byte buffers; avoid strings).
3. Document contents are periodically encrypted and written to SQLCipher.
4. Export/copy operations pass through a **confirmation gate** and emit an audit event.

---

## 4. Requirements (Prioritized)
### P0 (must ship in MVP)
- Vault create/unlock, Argon2id KDF, SQLCipher open.
- Document CRUD + autosave.
- Search (FTS5) + benchmark harness.
- PDF export + sanitization.
- OSC52 copy with confirmation + audit log.
- Lax Mode drafting + export-time structure validation.
- Startup hardening: disable core dumps; best-effort anti-swap protections; clear “security state” UI.

### P1 (post-MVP, strongly recommended)
- Hashed/blinded metadata for tags (HMAC) + optional padding strategy.
- Deterministic export reproducibility checks (byte-level diff against prior export).
- Memory capability tiers: runtime/secret experimental support + fallback secure buffers.
- Optional “clipboard sandbox” (internal encrypted clipboard).

### P2 (future / research)
- Tree-sitter incremental parsing for structure repair.
- In-memory FTS via custom VFS for large corpora.
- Hardware-backed unlock (FIDO2/TPM) + attestation flows.
- tmpfs draft mode + timed purge.

---

## 5. Cryptography & Key Management
### 5.1 Key derivation
- **KDF:** Argon2id.
- **Salt:** per-vault random salt generated by crypto/rand (16–32 bytes).
- **Parameters:** configurable; ship a conservative default profile and a “low-RAM” profile.

### 5.2 Vault master key lifecycle
- Master key exists only after unlock.
- Key is held in a dedicated buffer; best-effort zeroing on lock/exit.
- **Separate keys** (recommended):
  - `K_db` for SQLCipher database encryption
  - `K_audit` for audit log HMAC chain and optional encryption
  - `K_meta` for HMAC-tag blinding (if enabled)

### 5.3 Password quality (MVP)
- MVP requires a passphrase with a minimum length threshold.
- Provide feedback (strength meter), but do not block on complex policy.

---

## 6. Storage (SQLCipher) & Durability
### 6.1 Schema (MVP)
- `documents(id INTEGER PRIMARY KEY, created_at, updated_at, title_hint, body_cipher BLOB, body_hash BLOB)`
- `tags(id INTEGER PRIMARY KEY, name TEXT)` *(P1: store HMAC(tag) instead of plaintext)*
- `doc_tags(doc_id, tag_id)`
- `audit(seq INTEGER PRIMARY KEY, ts, event_type, doc_id, content_hash, bytes, dest, prev_hmac, hmac, notes)`

### 6.2 FTS5 design
Use **external content** FTS:
- `documents_fts(title_hint, body_plain_for_index, content='documents', content_rowid='id')`

MVP note: indexing plaintext for FTS implies plaintext exists transiently in process memory during indexing. Document this and minimize lifetime.

### 6.3 Crash consistency & corruption mitigation
Peer review highlights risk of corruption if long-lived SQLCipher handles are held across forced termination.
MVP strategy:
- Use short-lived transactions.
- Prefer conservative durability settings.
- On startup, run integrity routines:
  - basic SQLCipher open + schema validation
  - FTS consistency checks (rebuild if mismatch)
- Maintain a minimal backup/recovery story:
  - export vault backup command (copy while locked)
  - optional periodic checkpointing if WAL is used

---

## 7. Volatile Memory Hermeticism (Practical MVP)
Peer review consensus: “zeroing” is valuable but incomplete; CPU caches, registers, terminal buffers, swap, and core dumps can defeat naive assumptions.

### 7.1 Capability tiers
- **Tier A (preferred):** Go runtime experiment support for secret scopes when available.
- **Tier B:** locked buffers (mlock) + madvise(DONTDUMP) where supported + explicit zeroing.
- **Tier C:** plain Go buffers with explicit warnings.

MVP must detect and display which tier is active.

### 7.2 Secure-scope rules (MVP)
- No goroutines spawned inside secure scopes.
- Avoid converting sensitive `[]byte` to `string`.
- Avoid unbounded copies: append/slices must be audited.
- Explicit zeroing for buffers on:
  - document close
  - vault lock
  - export completion
  - process exit (best-effort)

### 7.3 OS-level hardening (MVP)
- Disable core dumps at startup (ulimit/rlimit equivalent).
- Mark process as non-dumpable where possible.
- Best-effort mlock of key buffers (document if permissions prevent it).
- Warn if swap is enabled and mlock is unavailable.

---

## 8. TUI & Terminal Integration (tcell / tmux / zellij)
Peer review emphasis: terminal stacks are “leaky plumbing.” The goal is to **minimize** leaks and **control egress**, not to promise impossibilities.

### 8.1 Input path mitigation
Problem: tcell event structs may contain plaintext runes allocated outside SDS’s control.
MVP mitigation:
- Immediately copy keystroke data into SDS-owned buffer.
- Zero/overwrite transient event buffers where feasible.
- Avoid storing raw event objects.

### 8.2 Rendering path mitigation
- Minimize retention of prior screen buffers.
- Avoid “debug logging” of raw keystrokes or document content.
- Disable mouse support by default.
- If mouse is enabled (`-m`), test under tmux and zellij and provide a safe-mode toggle.

### 8.3 OSC52 fragility
OSC52 can break or be filtered under nested multiplexers.
MVP requirements:
- Detect common nested sessions and warn.
- Require explicit confirmation before OSC52 copy.
- Provide “copy disabled” mode for high-sensitivity workflows.

---

## 9. Editing Model & Lax Mode
### 9.1 Lax Mode behavior (MVP)
- Lax Mode accepts any text and does not block typing.
- Structure validation runs:
  - on demand (manual “check structure”)
  - at export time (required)
- UI indicates “Lax Mode active” and shows a lightweight structure health indicator.

### 9.2 Export-time structure reconciliation (MVP)
- Apply deterministic heuristics to interpret headings and sections.
- If reconciliation cannot produce a valid structure, export UI must:
  - show precise errors
  - allow a “fix and retry” loop
  - never silently mutate without showing a diff/preview

(P2: tree-sitter incremental parsing for richer repairs.)

---

## 10. Export Pipeline (PDF)
### 10.1 PDF creation
- Markdown-ish parse → render via Maroto.
- Ensure exported PDFs do not include vault metadata (tags, folders, internal IDs).

### 10.2 PDF sanitization (MVP)
Peer review warns about PDF “noise” and covert channels.
MVP sanitization steps:
- Clear/normalize document metadata (author, creator, producer, timestamps).
- Strip unused objects/resources when possible.
- Deterministic normalization pass:
  - stable object ordering if feasible
  - stable timestamp
- Provide a `sds pdf-inspect` command that prints metadata and flags unexpected fields.

---

## 11. Egress Control & Audit Log
### 11.1 Egress events (MVP)
All egress must be mediated:
- **Export PDF**
- **Copy via OSC52**
- (Optional later) “external open” actions

### 11.2 Confirmation gates
- Copy confirmation threshold (default: >100 chars).
- Export confirmation if document has unresolved structure warnings.
- UI must clearly show byte counts and destination.

### 11.3 Append-only audit log (MVP)
- Each event writes:
  - `ts`, `event_type`, `doc_id`, `content_hash`, `bytes`, `dest`, `notes`
- Chain events with HMAC:
  - `hmac_i = HMAC(K_audit, prev_hmac || event_payload)`
- Store audit log inside the vault DB (MVP) or as a separate encrypted log file (P1).

### 11.4 Audit viewer
- TUI view to filter audit events.
- Export audit report to JSON (no plaintext content—hashes only).

---

## 12. CLI / UX Surface (MVP)
### 12.1 Commands
- `sds init` — create vault
- `sds open` — unlock + launch TUI
- `sds export <doc>` — export to PDF (headless)
- `sds audit` — show audit log (headless)
- `sds doctor` — environment checks (core dumps, swap, nested tmux, capability tier)

### 12.2 “Security state” indicator
Always visible:
- Vault locked/unlocked
- Capability tier (A/B/C)
- Clipboard mode (enabled/disabled)
- Structure health (OK/WARN/FAIL)

---

## 13. Testing & Verification Plan (MVP)
### 13.1 Correctness tests
- Schema migration tests.
- Save/load round-trip tests (hash stable).
- Export determinism tests (same input → same sanitized PDF bytes, where feasible).

### 13.2 Durability tests
- Kill process mid-transaction; verify vault opens and data remains consistent.
- WAL/DELETE mode tests depending on chosen configuration.

### 13.3 Security tests (best-effort)
- Ensure core dumps are disabled (assert rlimit).
- Ensure audit log chain verifies end-to-end.
- “Memory residue” tests:
  - debug build hooks to scan process memory segments for known sentinels after closing a secure scope (best-effort; not a proof).
  - cross-arch CI runs where possible.

### 13.4 Performance tests
- FTS indexing and query benchmarks at:
  - 100 docs
  - 1,000 docs
  - 10,000 docs
- Export throughput benchmark.

---

## 14. Implementation Plan (Repo Layout)
Suggested Go module layout:
- `cmd/sds/` — CLI entrypoint
- `internal/ui/` — tcell views + input routing
- `internal/vault/` — unlock, key lifecycle, capability tier detection
- `internal/store/` — SQLCipher DB layer, migrations, FTS
- `internal/export/` — parse → Maroto → sanitize
- `internal/egress/` — OSC52, confirmation gates, audit emission
- `internal/audit/` — HMAC chain, verification, viewer APIs
- `internal/doctor/` — environment checks

---

## 15. Roadmap (Phase Gates)
### Phase 0 — Skeleton & Doctor
- CLI init/open + doctor checks + placeholder UI.

### Phase 1 — Vault + Storage
- SQLCipher working, Argon2id unlock, CRUD docs, autosave.
**Gate:** crash test passes; vault recovers.

### Phase 2 — Editor + Search + Lax Mode
- tcell editor, doc list, FTS5 search, Lax Mode indicator and export-time validation.
**Gate:** strategist can draft without blocking; export can fail loudly and clearly.

### Phase 3 — Export + Egress Audit
- PDF export + sanitization + OSC52 copy gating + audit chain.
**Gate:** every export/copy is logged and verifiable; PDF metadata is sanitized.

---

## 16. Peer Review Traceability (Task Ledger)
This section maps peer-review themes to implementable tasks. Use these IDs as GitHub issues.

### 16.1 Memory / secret scope
- **PR-MEM-001 (P0):** Implement capability tiers (A/B/C) and always display active tier.
- **PR-MEM-002 (P0):** Disable core dumps at startup; mark non-dumpable where possible.
- **PR-MEM-003 (P0):** Best-effort mlock + madvise(DONTDUMP) for key buffers; warn on failure.
- **PR-MEM-004 (P1):** Add debug-only memory sentinel scanning after closing sensitive docs.

### 16.2 tcell / terminal leakage
- **PR-TUI-001 (P0):** Immediate keystroke copy into SDS buffers; avoid storing event objects.
- **PR-TUI-002 (P0):** Prohibit string conversions of sensitive buffers (lint + code review rule).
- **PR-TUI-003 (P0):** Mouse disabled by default; `-m` requires explicit enable + stability test notes.
- **PR-TUI-004 (P0):** Nested tmux/zellij detection + OSC52 warnings.

### 16.3 SQLCipher / durability
- **PR-DB-001 (P0):** Short-lived transactions; conservative durability mode; startup integrity routine.
- **PR-DB-002 (P0):** Migration framework and schema versioning.
- **PR-DB-003 (P0):** Benchmark harness for FTS5 under SQLCipher.

### 16.4 FTS5 / metadata
- **PR-FTS-001 (P0):** External-content FTS5; prepared statements; documented scale expectations.
- **PR-FTS-002 (P1):** Optional HMAC-blinded tags; avoid plaintext tag names at rest.

### 16.5 Lax Mode & structure
- **PR-UX-001 (P0):** Lax Mode toggle + visible indicator.
- **PR-UX-002 (P0):** Export-time validator with actionable errors and preview/diff.
- **PR-UX-003 (P2):** Tree-sitter incremental parsing for repair suggestions.

### 16.6 PDF sanitization
- **PR-PDF-001 (P0):** Strip/normalize PDF metadata; deterministic timestamp handling.
- **PR-PDF-002 (P0):** Add `pdf-inspect` tool to show remaining metadata.
- **PR-PDF-003 (P1):** Deterministic export regression tests; optional PDF/A research.

### 16.7 Egress & audit
- **PR-EGR-001 (P0):** OSC52 copy confirmation threshold + byte counts.
- **PR-EGR-002 (P0):** Append-only audit log with HMAC chain; verification command.
- **PR-EGR-003 (P1):** Separate audit key and/or separate encrypted audit store.
- **PR-EGR-004 (P1):** Optional “clipboard sandbox.”

---

## 17. Open Questions (Track as issues)
- What is our supported Go version policy for MVP (stable vs experimental runtime features)?
- Which SQLCipher durability mode is the default (DELETE/FULL vs WAL with checkpointing)?
- Do we index full plaintext for FTS5, or only a redacted subset (titles + selected fields)?
- What is the minimal acceptable PDF determinism target (metadata-only vs byte-identical)?
- What is the MVP stance on document padding / noise queries for access-pattern resistance?

---

## Appendix A: Glossary
- **Vault:** encrypted document store (SQLCipher DB file).
- **Egress:** any operation that moves plaintext out of SDS (PDF export, clipboard copy).
- **Clean Document:** exported PDF with no vault metadata (tags/folders/internal IDs).
- **Lax Mode:** drafting mode where structure enforcement is deferred until export validation.
- **Capability Tier:** runtime/OS support level for best-effort memory secrecy mechanisms.
